generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  MECHANIC
  RECEPTIONIST
}

enum JobStatus {
  ACCETTAZIONE
  IN_LAVORAZIONE
  TEST_SU_STRADA
  PRONTO
  CONSEGNATO
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  password       String
  name           String?
  role           Role      @default(MECHANIC)
  failedAttempts Int       @default(0)
  lockoutUntil   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// prisma/schema.prisma

model Customer {
  id             String    @id @default(cuid())
  firstName      String
  lastName       String
  email          String?   @unique
  phone          String    @unique
  alternatePhone String?   // Nuovo
  address        String?

  // CRM Avanzato - Note Separate
  technicalNotes String?   @db.Text // Visibili solo al meccanico (Box Azzurro)
  familyNotes    String?   @db.Text // Note personali ufficio (Box Arancione)

  // Statistiche e Loyalty
  totalSpent     Float     @default(0) // Aggiornato via trigger o server action
  totalMargin    Float     @default(0)
  lastVisit      DateTime?

  vehicles       Vehicle[]
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([phone])
  @@index([lastName])
}

model Vehicle {
  id        String   @id @default(cuid())
  plate     String   @unique
  brand     String
  model     String
  year      Int
  vin       String?  // Telaio
  fuelType  String?  // Benzina, Diesel, ecc.

  ownerId   String
  owner     Customer @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  jobs      Job[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([plate])
}

model Job {
  id          String    @id @default(cuid())
  title       String
  description String?
  status      JobStatus @default(ACCETTAZIONE)

  // Costi e Margini
  laborCost   Float     @default(0)
  partsCost   Float     @default(0) // Calcolato dalla somma dei ricambi
  totalAmount Float     @default(0)
  margin      Float     @default(0) // (totalAmount - laborCost - partsCost)

  vehicleId   String
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id])
  parts       PartOnJob[] // Manteniamo la relazione esistente con i ricambi

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Part {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  description String?
  
  // Gestione Margini
  buyPrice    Float       @default(0) // Prezzo di acquisto per l'officina
  sellPrice   Float       @default(0) // Prezzo di vendita al cliente
  
  stock       Int         @default(0)
  minStock    Int         @default(5)
  jobs        PartOnJob[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model PartOnJob {
  id           String   @id @default(cuid())
  jobId        String
  partId       String
  quantity     Int      @default(1)
  
  // Prezzo bloccato al momento dell'intervento per storicizzazione corretta
  appliedPrice Float    @default(0) 
  
  job          Job      @relation(fields: [jobId], references: [id])
  part         Part     @relation(fields: [partId], references: [id])

  @@unique([jobId, partId])
}