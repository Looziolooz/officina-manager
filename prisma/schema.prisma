generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  MECHANIC
  RECEPTIONIST
}

enum JobStatus {
  ACCETTAZIONE
  IN_LAVORAZIONE
  TEST_SU_STRADA
  PRONTO
  CONSEGNATO
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  password       String
  name           String?
  role           Role      @default(MECHANIC)
  failedAttempts Int       @default(0)
  lockoutUntil   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Customer {
  id             String    @id @default(cuid())
  firstName      String
  lastName       String
  email          String?   @unique
  phone          String
  address        String?
  
  // Note CRM Avanzato
  technicalNotes String?   @db.Text
  familyNotes    String?   @db.Text
  
  vehicles       Vehicle[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([phone]) // Ricerca rapida per numero di telefono
}

model Vehicle {
  id        String   @id @default(cuid())
  plate     String   @unique
  brand     String
  model     String
  year      Int
  vin       String?  // Telaio opzionale
  ownerId   String
  owner     Customer @relation(fields: [ownerId], references: [id])
  jobs      Job[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([plate]) // Ricerca rapida per targa
}

model Job {
  id          String      @id @default(cuid())
  title       String
  description String?
  status      JobStatus   @default(ACCETTAZIONE)
  
  // Statistiche e Margini
  laborCost   Float       @default(0) // Costo manodopera
  totalAmount Float       @default(0) // Fatturato totale dell'intervento
  
  vehicleId   String
  vehicle     Vehicle     @relation(fields: [vehicleId], references: [id])
  parts       PartOnJob[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Part {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  description String?
  
  // Gestione Margini
  buyPrice    Float       @default(0) // Prezzo di acquisto per l'officina
  sellPrice   Float       @default(0) // Prezzo di vendita al cliente
  
  stock       Int         @default(0)
  minStock    Int         @default(5)
  jobs        PartOnJob[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model PartOnJob {
  id           String   @id @default(cuid())
  jobId        String
  partId       String
  quantity     Int      @default(1)
  
  // Prezzo bloccato al momento dell'intervento per storicizzazione corretta
  appliedPrice Float    @default(0) 
  
  job          Job      @relation(fields: [jobId], references: [id])
  part         Part     @relation(fields: [partId], references: [id])

  @@unique([jobId, partId])
}