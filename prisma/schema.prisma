// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // o "sqlite"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  SUPER_ADMIN
  MANAGER
  MECHANIC
  RECEPTIONIST
}

enum JobStatus {
  SCHEDULED
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  DELIVERED
}

enum MaintenanceType {
  OIL_CHANGE
  BRAKE_SERVICE
  TIRE_ROTATION
  GENERAL_INSPECTION
  ENGINE_REPAIR
  TRANSMISSION
  ELECTRICAL
  BODYWORK
  OTHER
}

// Magazzino
enum MovementType {
  IN
  OUT
  ADJUSTMENT
  RETURN
  TRANSFER
}

enum StockLevel {
  CRITICAL
  LOW
  NORMAL
  HIGH
}

// Contabilità
enum AccountingType {
  INCOME        // Fattura attiva
  EXPENSE       // Fattura passiva / Spesa
  ADJUSTMENT    // Rettifica
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  CHECK
  PAYPAL
  SATISPAY
  OTHER
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT          // Inviata allo SDI
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

enum ExpenseCategory {
  RENT
  UTILITIES
  INSURANCE
  SALARIES
  TAXES
  PARTS_PURCHASE
  EQUIPMENT
  MAINTENANCE
  FUEL
  MARKETING
  SERVICES
  OTHER
}

// ==========================================
// CORE MODELS
// ==========================================

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  name           String
  password       String?
  role           Role            @default(MECHANIC)
  
  assignedJobs   Job[]
  jobNotes       JobNote[]
  stockMovements StockMovement[]
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Customer {
  id             String    @id @default(cuid())
  firstName      String
  lastName       String
  email          String?   @unique
  phone          String    @unique
  alternatePhone String?
  address        String?
  
  // Dati Fatturazione Elettronica
  companyName    String?   // Ragione Sociale (se azienda)
  vatNumber      String?   // Partita IVA
  fiscalCode     String?   // Codice Fiscale
  city           String?
  postalCode     String?
  province       String?
  country        String    @default("IT")
  pec            String?
  sdiCode        String?   // Codice Destinatario
  
  technicalNotes String?   @db.Text
  familyNotes    String?   @db.Text
  
  totalSpent     Float     @default(0)
  totalMargin    Float     @default(0)
  lastVisit      DateTime?

  vehicles       Vehicle[]
  invoices       Invoice[]
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([phone])
  @@index([lastName])
}

model Vehicle {
  id             String    @id @default(cuid())
  plate          String    @unique
  brand          String
  model          String
  year           Int
  vin            String?
  engineSize     String?
  fuelType       String?
  
  totalKm        Int       @default(0)
  lastOilChange  Int?
  lastInspection DateTime?
  nextOilChange  Int?
  nextInspection DateTime?

  ownerId        String
  owner          Customer  @relation(fields: [ownerId], references: [id])
  jobs           Job[]
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([plate])
}

model Job {
  id                String          @id @default(cuid())
  jobNumber         String          @unique
  title             String
  description       String?         @db.Text
  status            JobStatus       @default(SCHEDULED)
  priority          Int             @default(0)

  scheduledDate     DateTime
  startedAt         DateTime?
  completedAt       DateTime?
  deliveredAt       DateTime?
  estimatedDuration Int?

  vehicleId         String
  vehicle           Vehicle         @relation(fields: [vehicleId], references: [id])
  kmAtEntry         Int
  fuelLevel         Int?            @default(0)

  // Economia del Lavoro
  laborHours        Float           @default(0)
  laborRate         Float           @default(45)
  laborCost         Float           @default(0)
  partsCost         Float           @default(0)
  totalAmount       Float           @default(0)
  margin            Float           @default(0)

  maintenanceType   MaintenanceType?
  
  parts             PartOnJob[]
  photos            JobPhoto[]
  notes             JobNote[]
  
  assignedToId      String?
  assignedTo        User?           @relation(fields: [assignedToId], references: [id])

  // Relazioni Contabili
  invoice           Invoice?
  stockMovements    StockMovement[] // Per tracciare uso ricambi
  accountingRecords AccountingRecord[] // Opzionale: collegamento diretto alla prima nota

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([status])
  @@index([vehicleId])
}

model JobPhoto {
  id          String   @id @default(cuid())
  jobId       String
  url         String
  photoType   String   @default("GENERAL")
  description String?
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

model JobNote {
  id        String   @id @default(cuid())
  jobId     String
  content   String   @db.Text
  noteType  String   @default("GENERAL")
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

// ==========================================
// MAGAZZINO (WAREHOUSE)
// ==========================================

model Part {
  id                String          @id @default(cuid())
  code              String          @unique
  name              String
  description       String?         @db.Text
  category          String          @default("GENERIC")
  brand             String?
  
  buyPrice          Float           @default(0)
  sellPrice         Float           @default(0)
  markup            Float           @default(30)
  
  stock             Int             @default(0)
  minStock          Int             @default(5)
  maxStock          Int?            @default(50)
  reorderPoint      Int?            @default(10)
  stockLevel        StockLevel      @default(NORMAL)
  
  location          String?
  barcode           String?         @unique
  supplierCode      String?
  supplierName      String?
  
  totalValue        Float           @default(0)
  lastPurchasePrice Float?
  lastPurchaseDate  DateTime?
  
  jobs              PartOnJob[]
  movements         StockMovement[]
  alerts            StockAlert[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([category])
  @@index([stockLevel])
}

model PartOnJob {
  id           String   @id @default(cuid())
  jobId        String
  partId       String
  quantity     Int      @default(1)
  appliedPrice Float    
  discount     Float    @default(0)
  
  job          Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  part         Part     @relation(fields: [partId], references: [id])
  
  createdAt    DateTime @default(now())

  @@unique([jobId, partId])
}

model StockMovement {
  id                String        @id @default(cuid())
  movementNumber    String        @unique
  type              MovementType
  
  partId            String
  part              Part          @relation(fields: [partId], references: [id])
  quantity          Int
  
  unitPrice         Float         @default(0)
  totalValue        Float         @default(0) 
  
  jobId             String?       
  job               Job?          @relation(fields: [jobId], references: [id])

  documentNumber    String?
  
  stockBefore       Int
  stockAfter        Int
  
  notes             String?       @db.Text
  reason            String?       
  
  performedById     String
  performedBy       User          @relation(fields: [performedById], references: [id])
  
  createdAt         DateTime      @default(now())
  
  @@index([partId])
  @@index([type])
}

model StockAlert {
  id                String    @id @default(cuid())
  partId            String
  part              Part      @relation(fields: [partId], references: [id], onDelete: Cascade)
  alertType         String
  message           String
  severity          String    @default("WARNING")
  isRead            Boolean   @default(false)
  readAt            DateTime?
  readById          String?
  createdAt         DateTime  @default(now())
  
  @@index([isRead])
  @@index([severity])
}

// ==========================================
// CONTABILITÀ (ACCOUNTING)
// ==========================================

model Invoice {
  id                String          @id @default(cuid())
  invoiceNumber     String          @unique // "FT-2024-001"
  year              Int
  number            Int             // Progressivo numerico
  status            InvoiceStatus   @default(DRAFT)
  
  issueDate         DateTime        @default(now())
  dueDate           DateTime
  paidDate          DateTime?

  // Cliente
  customerId        String
  customer          Customer        @relation(fields: [customerId], references: [id])

  // Collegamento Job (1 a 1 opzionale)
  jobId             String?         @unique
  job               Job?            @relation(fields: [jobId], references: [id])

  // Importi
  subtotal          Float           @default(0) // Imponibile
  taxRate           Float           @default(22)
  taxAmount         Float           @default(0)
  total             Float           @default(0)
  
  // Pagamento
  amountPaid        Float           @default(0)
  amountDue         Float           @default(0)
  paymentMethod     PaymentMethod?
  
  notes             String?         @db.Text
  internalNotes     String?         @db.Text

  items             InvoiceItem[]
  accountingRecord  AccountingRecord?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([status])
  @@index([issueDate])
}

model InvoiceItem {
  id                String    @id @default(cuid())
  invoiceId         String
  invoice           Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description       String
  quantity          Float     @default(1)
  unitPrice         Float
  discount          Float     @default(0)
  vatRate           Float     @default(22)
  subtotal          Float     

  createdAt         DateTime  @default(now())
}

model Expense {
  id                String          @id @default(cuid())
  expenseNumber     String?         // Riferimento fattura fornitore
  
  category          ExpenseCategory
  description       String
  
  amount            Float           // Imponibile
  taxAmount         Float           @default(0)
  totalAmount       Float
  
  expenseDate       DateTime        @default(now())
  dueDate           DateTime?
  paidDate          DateTime?
  
  isPaid            Boolean         @default(false)
  paymentMethod     PaymentMethod?
  
  supplierName      String
  supplierVAT       String?
  
  // Collegamento contabile
  accountingRecord  AccountingRecord?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([category])
  @@index([expenseDate])
}

model AccountingRecord {
  id                String          @id @default(cuid())
  recordNumber      String          @unique // "REG-2024-001"
  type              AccountingType
  
  date              DateTime        @default(now())
  
  // Importi
  amount            Float           // Imponibile
  totalAmount       Float           // Totale
  
  category          String
  description       String
  
  // Collegamenti
  invoiceId         String?         @unique
  invoice           Invoice?        @relation(fields: [invoiceId], references: [id])
  
  expenseId         String?         @unique
  expense           Expense?        @relation(fields: [expenseId], references: [id])
  
  jobId             String?
  job               Job?            @relation(fields: [jobId], references: [id])

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([type])
  @@index([date])
}