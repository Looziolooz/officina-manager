// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // o "sqlite"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  MECHANIC
  RECEPTIONIST
  VIEWER
}

enum AuditAction {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_CHANGED
  TWO_FA_ENABLED
  TWO_FA_DISABLED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  // Business
  CUSTOMER_CREATED
  JOB_CREATED
  INVOICE_CREATED
}

enum JobStatus {
  SCHEDULED
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  DELIVERED
}

enum MaintenanceType {
  OIL_CHANGE
  BRAKE_SERVICE
  TIRE_ROTATION
  GENERAL_INSPECTION
  ENGINE_REPAIR
  TRANSMISSION
  ELECTRICAL
  BODYWORK
  OTHER
}

// Magazzino
enum MovementType {
  IN
  OUT
  ADJUSTMENT
  RETURN
  TRANSFER
}

enum StockLevel {
  CRITICAL
  LOW
  NORMAL
  HIGH
}

// Contabilit√†
enum AccountingType {
  INCOME
  EXPENSE
  ADJUSTMENT
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  CHECK
  PAYPAL
  SATISPAY
  OTHER
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

enum ExpenseCategory {
  RENT
  UTILITIES
  INSURANCE
  SALARIES
  TAXES
  PARTS_PURCHASE
  EQUIPMENT
  MAINTENANCE
  FUEL
  MARKETING
  SERVICES
  OTHER
}

// SMS
enum SMSProvider {
  TWILIO
  VONAGE
  MESSAGEBIRD
  MANUAL
}

enum SMSStatus {
  PENDING
  SENDING
  SENT
  DELIVERED
  FAILED
  REJECTED
  QUEUED
}

enum SMSType {
  OIL_CHANGE_REMINDER
  INSPECTION_REMINDER
  CAR_READY
  APPOINTMENT_CONFIRM
  QUOTE_READY
  PAYMENT_REMINDER
  MARKETING
  CUSTOM
}

// --- CORE MODELS ---

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String
  password          String    
  role              Role      @default(VIEWER)
  
  // Account Status
  isActive          Boolean   @default(true)
  isLocked          Boolean   @default(false)
  lockedUntil       DateTime?
  
  // Login Tracking
  loginAttempts     Int       @default(0)
  lastLoginAttempt  DateTime?
  lastLoginSuccess  DateTime?
  lastLoginIP       String?
  
  // Password Policy
  passwordChangedAt DateTime  @default(now())
  mustChangePassword Boolean  @default(false)
  
  // 2FA
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?   
  
  // Backup Codes
  backupCodes       TwoFactorBackupCode[]

  // Relazioni Officina
  assignedJobs      Job[]     
  jobNotes          JobNote[]
  stockMovements    StockMovement[] 
  
  // Security Relazioni
  auditLogs         AuditLog[]
  sessions          Session[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  ipAddress    String?
  userAgent    String?  @db.Text
  
  createdAt    DateTime @default(now())
}

model TwoFactorBackupCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String   // Hashed
  used      Boolean  @default(false)
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

model AuditLog {
  id           String      @id @default(cuid())
  
  userId       String?
  user         User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail    String?     
  userName     String?     
  userRole     Role?       
  
  action       AuditAction
  resource     String?     
  resourceId   String?     
  
  description  String      @db.Text
  metadata     Json?       
  
  ipAddress    String?
  userAgent    String?     @db.Text
  
  isSuccess    Boolean     @default(true)
  riskLevel    String?     @default("LOW") 
  
  createdAt    DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Customer {
  id             String    @id @default(cuid())
  firstName      String
  lastName       String
  email          String?   @unique
  phone          String    @unique
  alternatePhone String?
  address        String?
  
  companyName    String?   
  vatNumber      String?   
  fiscalCode     String?   
  city           String?
  postalCode     String?
  province       String?
  country        String    @default("IT")
  pec            String?
  sdiCode        String?   
  
  technicalNotes String?   @db.Text
  familyNotes    String?   @db.Text
  
  totalSpent     Float     @default(0)
  totalMargin    Float     @default(0)
  lastVisit      DateTime?

  smsEnabled        Boolean    @default(true)
  marketingSMS      Boolean    @default(false)
  privacyConsent    Boolean    @default(false)
  privacyConsentDate DateTime?

  vehicles       Vehicle[]
  invoices       Invoice[]
  smsMessages    SMSMessage[]
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([phone])
  @@index([lastName])
}

model Vehicle {
  id             String    @id @default(cuid())
  plate          String    @unique
  brand          String
  model          String
  year           Int
  vin            String?
  engineSize     String?
  fuelType       String?
  
  totalKm        Int       @default(0)
  
  lastOilChange      Int?
  lastOilChangeDate  DateTime?
  lastInspection     DateTime?
  
  nextOilChange      Int?
  nextOilChangeDate  DateTime?
  nextInspection     DateTime?

  oilChangeReminders  Boolean  @default(true)
  inspectionReminders Boolean  @default(true)

  ownerId        String
  owner          Customer  @relation(fields: [ownerId], references: [id])
  jobs           Job[]
  smsMessages    SMSMessage[]
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([plate])
}

model Job {
  id                String          @id @default(cuid())
  jobNumber         String          @unique
  title             String
  description       String?         @db.Text
  status            JobStatus       @default(SCHEDULED)
  priority          Int             @default(0)

  scheduledDate     DateTime
  startedAt         DateTime?
  completedAt       DateTime?
  deliveredAt       DateTime?
  estimatedDuration Int?

  vehicleId         String
  vehicle           Vehicle         @relation(fields: [vehicleId], references: [id])
  kmAtEntry         Int
  fuelLevel         Int?            @default(0)

  laborHours        Float           @default(0)
  laborRate         Float           @default(45)
  laborCost         Float           @default(0)
  partsCost         Float           @default(0)
  totalAmount       Float           @default(0)
  margin            Float           @default(0)

  maintenanceType   MaintenanceType?
  
  parts             PartOnJob[]
  photos            JobPhoto[]
  notes             JobNote[]
  
  assignedToId      String?
  assignedTo        User?           @relation(fields: [assignedToId], references: [id])

  invoice           Invoice?
  stockMovements    StockMovement[] 
  accountingRecords AccountingRecord[] 

  readySMSSent      Boolean       @default(false)
  readySMSSentAt    DateTime?
  smsMessages       SMSMessage[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([status])
  @@index([vehicleId])
}

model JobPhoto {
  id          String   @id @default(cuid())
  jobId       String
  url         String
  photoType   String   @default("GENERAL")
  description String?
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

model JobNote {
  id        String   @id @default(cuid())
  jobId     String
  content   String   @db.Text
  noteType  String   @default("GENERAL")
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Part {
  id                String          @id @default(cuid())
  code              String          @unique
  name              String
  description       String?         @db.Text
  category          String          @default("GENERIC")
  brand             String?
  
  buyPrice          Float           @default(0)
  sellPrice         Float           @default(0)
  markup            Float           @default(30)
  
  stock             Int             @default(0)
  minStock          Int             @default(5)
  maxStock          Int?            @default(50)
  reorderPoint      Int?            @default(10)
  stockLevel        StockLevel      @default(NORMAL)
  
  location          String?
  barcode           String?         @unique
  supplierCode      String?
  supplierName      String?
  
  totalValue        Float           @default(0)
  lastPurchasePrice Float?
  lastPurchaseDate  DateTime?
  
  jobs              PartOnJob[]
  movements         StockMovement[]
  alerts            StockAlert[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([category])
  @@index([stockLevel])
}

model PartOnJob {
  id           String   @id @default(cuid())
  jobId        String
  partId       String
  quantity     Int      @default(1)
  appliedPrice Float    
  discount     Float    @default(0)
  
  job          Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  part         Part     @relation(fields: [partId], references: [id])
  
  createdAt    DateTime @default(now())

  @@unique([jobId, partId])
}

model StockMovement {
  id                String        @id @default(cuid())
  movementNumber    String        @unique
  type              MovementType
  
  partId            String
  part              Part          @relation(fields: [partId], references: [id])
  quantity          Int
  
  unitPrice         Float         @default(0)
  totalValue        Float         @default(0) 
  
  jobId             String?       
  job               Job?          @relation(fields: [jobId], references: [id])

  documentNumber    String?
  
  stockBefore       Int
  stockAfter        Int
  
  notes             String?       @db.Text
  reason            String?       
  
  performedById     String
  performedBy       User          @relation(fields: [performedById], references: [id])
  
  createdAt         DateTime      @default(now())
  
  @@index([partId])
  @@index([type])
}

model StockAlert {
  id                String    @id @default(cuid())
  partId            String
  part              Part      @relation(fields: [partId], references: [id], onDelete: Cascade)
  alertType         String
  message           String
  severity          String    @default("WARNING")
  isRead            Boolean   @default(false)
  readAt            DateTime?
  readById          String?
  createdAt         DateTime  @default(now())
  
  @@index([isRead])
  @@index([severity])
}

model Invoice {
  id                String          @id @default(cuid())
  invoiceNumber     String          @unique 
  year              Int
  number            Int             
  status            InvoiceStatus   @default(DRAFT)
  
  issueDate         DateTime        @default(now())
  dueDate           DateTime
  paidDate          DateTime?

  customerId        String
  customer          Customer        @relation(fields: [customerId], references: [id])

  jobId             String?         @unique
  job               Job?            @relation(fields: [jobId], references: [id])

  subtotal          Float           @default(0) 
  taxRate           Float           @default(22)
  taxAmount         Float           @default(0)
  total             Float           @default(0)
  
  amountPaid        Float           @default(0)
  amountDue         Float           @default(0)
  paymentMethod     PaymentMethod?
  
  notes             String?         @db.Text
  internalNotes     String?         @db.Text

  items             InvoiceItem[]
  accountingRecord  AccountingRecord?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([status])
  @@index([issueDate])
}

model InvoiceItem {
  id                String    @id @default(cuid())
  invoiceId         String
  invoice           Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description       String
  quantity          Float     @default(1)
  unitPrice         Float
  discount          Float     @default(0)
  vatRate           Float     @default(22)
  subtotal          Float     

  createdAt         DateTime  @default(now())
}

model Expense {
  id                String          @id @default(cuid())
  expenseNumber     String?         
  
  category          ExpenseCategory
  description       String
  
  amount            Float           
  taxAmount         Float           @default(0)
  totalAmount       Float
  
  expenseDate       DateTime        @default(now())
  dueDate           DateTime?
  paidDate          DateTime?
  
  isPaid            Boolean         @default(false)
  paymentMethod     PaymentMethod?
  
  supplierName      String
  supplierVAT       String?
  
  accountingRecord  AccountingRecord?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([category])
  @@index([expenseDate])
}

model AccountingRecord {
  id                String          @id @default(cuid())
  recordNumber      String          @unique 
  type              AccountingType
  
  date              DateTime        @default(now())
  
  amount            Float           
  totalAmount       Float           
  
  category          String
  description       String
  
  invoiceId         String?         @unique
  invoice           Invoice?        @relation(fields: [invoiceId], references: [id])
  
  expenseId         String?         @unique
  expense           Expense?        @relation(fields: [expenseId], references: [id])
  
  jobId             String?
  job               Job?            @relation(fields: [jobId], references: [id])

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([type])
  @@index([date])
}

model SMSMessage {
  id                String          @id @default(cuid())
  
  phoneNumber       String
  customerId        String?
  customer          Customer?       @relation(fields: [customerId], references: [id])
  
  message           String          @db.Text
  type              SMSType
  
  provider          SMSProvider
  status            SMSStatus       @default(PENDING)
  providerMessageId String?
  
  attempts          Int             @default(0)
  maxAttempts       Int             @default(3)
  lastAttemptAt     DateTime?
  
  cost              Float?
  creditsUsed       Float?
  
  scheduledFor      DateTime?
  sentAt            DateTime?
  deliveredAt       DateTime?
  failedAt          DateTime?
  
  errorMessage      String?         @db.Text
  providerResponse  String?         @db.Text
  
  vehicleId         String?
  vehicle           Vehicle?        @relation(fields: [vehicleId], references: [id])
  jobId             String?
  job               Job?            @relation(fields: [jobId], references: [id])
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([status])
  @@index([type])
  @@index([scheduledFor])
  @@index([customerId])
}

model SMSProviderConfig {
  id                String      @id @default(cuid())
  provider          SMSProvider @unique
  
  isEnabled         Boolean     @default(true)
  priority          Int         @default(1)
  name              String      
  
  dailyLimit        Int         @default(100)
  messagesSentToday Int         @default(0)
  costPerSMS        Float       @default(0.08)
  
  remainingCredits  Float       @default(0)
  
  lastUsedAt        DateTime?
  successRate       Float       @default(100)
  totalSent         Int         @default(0)
  totalFailed       Int         @default(0)
  
  lastResetDate     DateTime    @default(now())
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}